<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Platform - Retro Ping Pong 2D</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/script.js" defer></script>
    <style>
        .pong-wrap {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
        }
        #pongCanvas {
            border: 2px solid var(--accent-purple);
            border-radius: 12px;
            background: #05050a;
            box-shadow: 0 0 25px rgba(124, 58, 237, 0.35);
            max-width: 100%;
        }
        .pong-hud {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <svg viewBox="0 0 24 24" width="28" height="28"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            NEXUS
        </div>
        <nav class="nav-links">
            <div class="nav-item" data-page="/">Главная</div>
            <div class="nav-item" data-page="/shop">Магазин</div>
            <div class="nav-item" data-page="/community">Сообщество</div>
            <div class="nav-item" data-page="/stream">Стримы</div>
            <div class="nav-item" data-page="/pong">Pong 2D</div>
            <div class="nav-item" data-page="/profile">Профиль</div>
            <div class="nav-item" data-page="/admin">Админ</div>
        </nav>
        <div class="user-profile" data-page="/profile" title="Открыть профиль">
            <div class="balance">4 500 ₸</div>
            <div class="avatar" style="background-image: url('https://placehold.co/100x100/4c1d95/FFF?text=U'); background-size: cover;"></div>
        </div>
    </header>

    <div class="main-container">
        <main class="content-area">
            <div class="section-title">Retro Ping Pong 2D</div>
            <div class="pong-wrap">
                <div class="pong-hud">
                    <div>Счет: <strong id="scoreLabel">0 : 0</strong></div>
                    <div>Комната: <strong id="roomLabel">public</strong></div>
                    <div>Сторона: <strong id="sideLabel">-</strong></div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input id="pongRoomInput" class="admin-input" style="width:120px; padding:8px; font-size:12px;" placeholder="room id" value="public">
                        <button id="pongCreateBtn" class="btn btn-secondary" style="padding:8px 14px; font-size:12px;">Создать</button>
                        <button id="pongJoinBtn" class="btn btn-secondary" style="padding:8px 14px; font-size:12px;">Войти</button>
                        <span style="color: var(--text-muted); font-size: 13px;">Управление: W/S или ↑/↓</span>
                        <button id="pongResetBtn" class="btn btn-secondary" style="padding:8px 14px; font-size:12px;">Новая игра</button>
                    </div>
                </div>
                <div style="width:100%; max-width:800px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:10px; padding:10px;">
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px;">Активные комнаты</div>
                    <div id="pongRoomsList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
                <div style="width:100%; max-width:800px; display:flex; gap:12px; font-size:12px; color:var(--text-muted);">
                    <div>Handshake: <strong id="hsLabel">...</strong></div>
                    <div>Ping: <strong id="pingLabel">-</strong></div>
                    <div>Sync: <strong id="syncLabel">-</strong></div>
                    <div>Status: <strong id="statusLabel">init</strong></div>
                </div>
                <canvas id="pongCanvas" width="800" height="500"></canvas>
            </div>
        </main>
    </div>

    <div id="notification-container"></div>

    <script>
        const canvas = document.getElementById('pongCanvas');
        const ctx = canvas.getContext('2d');
        const scoreLabel = document.getElementById('scoreLabel');
        const resetBtn = document.getElementById('pongResetBtn');
        const createBtn = document.getElementById('pongCreateBtn');
        const joinBtn = document.getElementById('pongJoinBtn');
        const roomInput = document.getElementById('pongRoomInput');
        const roomLabel = document.getElementById('roomLabel');
        const sideLabel = document.getElementById('sideLabel');
        const roomsList = document.getElementById('pongRoomsList');
        const hsLabel = document.getElementById('hsLabel');
        const pingLabel = document.getElementById('pingLabel');
        const syncLabel = document.getElementById('syncLabel');
        const statusLabel = document.getElementById('statusLabel');

        const token = localStorage.getItem('nexus_auth_token');
        let socket = null;
        let gameState = null;
        let currentDirection = 0;
        let mySide = 'spectator';
        let joinedRoom = 'public';

        async function apiFetch(url, options = {}) {
            const headers = { ...(options.headers || {}) };
            if (token) headers.Authorization = `Bearer ${token}`;
            const res = await fetch(url, { ...options, headers });
            let data = {};
            try { data = await res.json(); } catch (_) {}
            if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
            return data;
        }

        function renderRooms(rooms) {
            if (!roomsList) return;
            roomsList.innerHTML = (rooms || []).length
                ? rooms.map((r) => `
                    <button type="button" data-room-id="${r.id}" class="btn btn-secondary" style="padding:6px 10px; font-size:11px;">
                        ${r.id} (${r.players_count}/2)
                    </button>
                `).join('')
                : '<span style="font-size:12px; color:var(--text-muted);">Пока нет комнат</span>';

            roomsList.querySelectorAll('[data-room-id]').forEach((btn) => {
                btn.addEventListener('click', () => {
                    roomInput.value = btn.getAttribute('data-room-id');
                    joinBtn.click();
                });
            });
        }

        async function refreshRooms() {
            if (!token) return;
            try {
                const rooms = await apiFetch('/api/pong/rooms');
                renderRooms(rooms);
            } catch (_) {
                renderRooms([]);
            }
        }

        if (!token || typeof io !== 'function') {
            scoreLabel.textContent = 'Требуется вход';
            statusLabel.textContent = 'no-auth-or-io';
        } else {
            socket = io({ auth: { token } });

            socket.on('connect', () => {
                statusLabel.textContent = 'connected';
                socket.emit('client_handshake', {
                    page: 'pong',
                    client_time: new Date().toISOString()
                });
            });

            socket.on('disconnect', () => {
                statusLabel.textContent = 'disconnected';
            });

            socket.on('connect_error', (err) => {
                statusLabel.textContent = `connect_error: ${err?.message || 'unknown'}`;
            });

            socket.on('site_handshake', () => {
                hsLabel.textContent = 'site-ok';
            });

            socket.on('handshake_ack', (data) => {
                hsLabel.textContent = data?.ok ? 'ack-ok' : 'ack-fail';
            });

            socket.on('sync_pong', (data) => {
                const now = Date.now();
                const rtt = Math.max(0, now - Number(data?.client_ts || now));
                pingLabel.textContent = `${rtt} ms`;
            });

            socket.on('sync_heartbeat_ack', (data) => {
                syncLabel.textContent = `room=${data?.room || '-'} users=${data?.players_count ?? 0}`;
            });

            socket.on('pong_joined', (data) => {
                joinedRoom = data.room;
                mySide = data.side;
                roomLabel.textContent = joinedRoom;
                sideLabel.textContent = mySide;
            });

            socket.on('pong_state', (state) => {
                gameState = state;
                scoreLabel.textContent = `${state.left_score} : ${state.right_score}`;
                draw();
            });

            socket.on('pong_rooms_update', (rooms) => {
                renderRooms(rooms);
            });

            refreshRooms();
        }

        function sendDirection(dir) {
            if (!socket) return;
            if (mySide !== 'left' && mySide !== 'right') return;
            if (currentDirection === dir) return;
            currentDirection = dir;
            socket.emit('pong_input', { direction: dir });
        }

        document.addEventListener('keydown', (e) => {
            if (['w', 'W', 'ArrowUp'].includes(e.key)) sendDirection(-1);
            if (['s', 'S', 'ArrowDown'].includes(e.key)) sendDirection(1);
        });

        document.addEventListener('keyup', (e) => {
            if (['w', 'W', 'ArrowUp', 's', 'S', 'ArrowDown'].includes(e.key)) {
                sendDirection(0);
            }
        });

        function drawCenterLine() {
            ctx.strokeStyle = '#7c3aed';
            ctx.setLineDash([8, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function draw() {
            if (!gameState) return;

            ctx.fillStyle = '#05050a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawCenterLine();

            // left paddle
            ctx.fillStyle = '#fbbf24';
            ctx.fillRect(18, gameState.left_y, gameState.paddle_w, gameState.paddle_h);

            // right paddle
            ctx.fillStyle = '#a78bfa';
            ctx.fillRect(canvas.width - 30, gameState.right_y, gameState.paddle_w, gameState.paddle_h);

            // ball
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(gameState.ball_x, gameState.ball_y, 7, 0, Math.PI * 2);
            ctx.fill();
        }

        joinBtn.addEventListener('click', () => {
            if (!socket) return;
            const room = (roomInput.value || 'public').trim().toLowerCase();
            socket.emit('pong_join', { room });
            statusLabel.textContent = `join:${room}`;
        });

        createBtn.addEventListener('click', async () => {
            if (!socket) return;
            try {
                const room = (roomInput.value || '').trim().toLowerCase();
                const payload = await apiFetch('/api/pong/rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room })
                });
                roomInput.value = payload.room;
                statusLabel.textContent = `created:${payload.room}`;
                joinBtn.click();
            } catch (err) {
                statusLabel.textContent = `create_error:${err.message || 'unknown'}`;
            }
        });

        resetBtn.addEventListener('click', () => {
            if (!socket) return;
            socket.emit('pong_reset');
        });

        // auto-join default
        joinBtn.click();

        setInterval(() => {
            if (!socket || !socket.connected) return;
            socket.emit('sync_ping', { client_ts: Date.now(), echo: 'pong-page' });
            socket.emit('sync_heartbeat', { client_time: new Date().toISOString() });
        }, 3000);
    </script>
</body>
</html>